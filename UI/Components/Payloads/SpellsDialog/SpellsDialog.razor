@using Newtonsoft.Json
@using Shared.Dtos
@using Shared.Enums
@using System.Net.Http.Json
@using System.Text
@using Shared.Static
@using Ui.Services
<MatDialog IsOpenChanged="@IsSpellsDialogOpenChanged" IsOpen="IsSpellsDialogOpen">
    <MatDialogTitle>@SpellType.Scan.ToString()</MatDialogTitle>
    <MatDialogContent>
        <div class="mat-layout-grid">
            <div class="mat-layout-grid-inner">
                @foreach (var spell in OrbitalScans)
                {
                    <div class="mat-layout-grid-cell">
                        <BaseCard Title="@spell.Title" ImageUrl="@spell.Image">
                            <ChildContent>
                                @spell.Description
                            </ChildContent>
                            <Actions>
                                <MatButton OnClick="@(async e => { await SpellChosen(spell); })">Launch</MatButton>
                            </Actions>
                        </BaseCard>
                    </div>
                }
            </div>
        </div>

    </MatDialogContent>
    <MatDialogActions>
        <MatButton OnClick="@(e => { CloseSpellsDialog.InvokeAsync(); })">Close</MatButton>
    </MatDialogActions>
</MatDialog>
<SpellDialog SpellToLaunch="SelectedOrbitalScan" IsSpellDialogOpen="IsSpellDialogOpen" OnConfigured="@LaunchSpell">

</SpellDialog>


<style>
    .mdc-dialog__container {
        min-width: 90%;
    }

    .mdc-dialog .mdc-dialog__surface {
        max-height: 80%;
        background-color: white;
        max-width: none;
        min-width: 85%;
    }
</style>

@code {
    [Inject]
    private IMatToaster Toaster { get; set; }

    [Parameter]
    public EventCallback<bool> CloseSpellsDialog { get; set; }

    [Parameter]
    public bool IsSpellsDialogOpen { get; set; }

    public bool IsSpellDialogOpen { get; set; }

    [Parameter]
    public Payload Payload { get; set; }

    [Inject]
    private RodinHttpClient OrbitalHttpClient { get; set; }

    OrbitalScan SelectedOrbitalScan { get; set; }

    private readonly List<OrbitalScan> OrbitalScans = new List<OrbitalScan>() {

    new OrbitalScan() {
    Title = "Simple Scan",
    Endpoint = "Scans",
    Description = "Scan a payload with a single antivirus",
    Image = "images/simple_scan.png",
    SupportedPayloads = Enum.GetValues(typeof(PayloadType)).Cast<PayloadType>().ToList()},

    new OrbitalScan() {
    Title = "Scan all",
    Endpoint = "Scans",
    Description = "Scan a payload with every supported antiviruses",
    Image = "images/offline_virustotal.png",
    IsAppliedToAllAntivirus = true,
    SupportedPayloads = Enum.GetValues(typeof(PayloadType)).Cast<PayloadType>().ToList()},


    new OrbitalScan() {
    Title = "Dissect",
    Endpoint = "Dissect",
    Description = "Statically analyse every functions of a payload separatly, and returns which ones are flagged, and which ones are healthy",
    Image = "images/dissect.png",
    SupportedPayloads = new List<PayloadType> { PayloadType.NativeExecutable, PayloadType.NativeLibrary } },

    new OrbitalScan() {
    Title = "Dissect",
    Endpoint = "Dissect",
    Description = "Statically analyse every functions of a payload separatly, and returns which ones are flagged, and which ones are healthy",
    Image = "images/dissect.png" }
    };

    private void IsSpellsDialogOpenChanged(bool isSpellsDialogOpen)
    {
        IsSpellsDialogOpen = isSpellsDialogOpen;
        if (!IsSpellsDialogOpen) IsSpellDialogOpen = false;
    }

    private async Task SpellChosen(OrbitalScan orbitalScan)
    {
        SelectedOrbitalScan = orbitalScan;
        if (orbitalScan.IsAppliedToAllAntivirus)
        {
            await LaunchSpell(Enum.GetValues(typeof(SupportedAntivirus)).Cast<SupportedAntivirus>().ToList());
        }
        else
        {
            IsSpellDialogOpen = true;
        }
    }


    private async Task LaunchSpell(List<SupportedAntivirus> antiviruses)
    {
        var OrbitalClient = OrbitalHttpClient.Client;
        HttpResponseMessage response = new();
        var ScanPost = new ScanPost
        {
            PayloadId = Payload.Id,
            Antiviruses = antiviruses
        };
        var endpoint = SelectedOrbitalScan.Endpoint;

        @*var test = JsonContent.Create(ScanPost);*@
        try
        {
            response = await OrbitalClient.PostAsync(endpoint, JsonHelper.SerializeAsync(ScanPost));
        }
        catch (Exception ex)
        {
            Toaster.Add(ex.Message, MatToastType.Danger);
        }

        if (!response.IsSuccessStatusCode)
        {
            await OrbitalHttpClient.ShowAndLogError(response);
        }
    }

}
